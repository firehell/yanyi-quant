# Polygon.io 股票 WebSocket 接口文档

## 目录
- [Polygon.io 股票 WebSocket 接口文档](#polygonio-股票-websocket-接口文档)
  - [目录](#目录)
  - [概述](#概述)
  - [市场时间和时区](#市场时间和时区)
  - [基础设施和可靠性](#基础设施和可靠性)
  - [数据流：从交易所到用户](#数据流从交易所到用户)
  - [WebSocket数据流导航](#websocket数据流导航)
  - [可用的WebSocket数据流](#可用的websocket数据流)
    - [聚合数据（每分钟）](#聚合数据每分钟)
    - [聚合数据（每秒）](#聚合数据每秒)
    - [交易数据](#交易数据)
    - [报价数据](#报价数据)
    - [涨跌停限制 (LULD)](#涨跌停限制-luld)
    - [公平市场价值 (FMV)](#公平市场价值-fmv)
  - [连接和认证](#连接和认证)
  - [订阅格式](#订阅格式)
  - [错误处理](#错误处理)
  - [最佳实践](#最佳实践)

## 概述

Polygon.io通过WebSocket提供对美国股票市场数据的实时流式访问，将连续的更新直接推送到您的应用程序。我们的WebSocket数据流包括交易、报价、聚合数据（K线）、涨跌停限制（LULD）事件和公平市场价值（FMV）测量，使开发者、交易员和分析师能够以最小延迟接收实时、基于推送的市场数据。通过接入这些流式端点，您可以为动态仪表盘提供动力、驱动算法交易策略，并在市场状况变化时实时监控——无需重复请求。

## 市场时间和时区

通过WebSocket传送的所有股票市场数据都遵循美国东部时间（ET）的标准美国股票交易时段：

* 盘前交易：东部时间上午4:00至上午9:30
* 常规市场：东部时间上午9:30至下午4:00
* 盘后交易：东部时间下午4:00至晚上8:00

尽管流式端点在常规交易时间之外保持活跃，但更新的频率和类型可能会根据市场活动和相关数据源而有所不同。标准化为东部时间确保跨所有交易时段的一致集成，并简化时间敏感的分析。

## 基础设施和可靠性

我们的WebSocket基础设施经过精心设计，注重速度、稳定性和可扩展性。通过与交易所和证券信息处理器（SIP）共同部署服务器，我们能够最小化延迟，确保您尽快收到更新。冗余数据中心和负载均衡进一步增强了可靠性，使我们能够在高负载或挑战性网络条件下保持稳定的数据传输。

这种实时架构确保了无缝、连续的数据流，非常适合对延迟敏感的应用程序，如算法交易、实时图表和事件驱动分析。

## 数据流：从交易所到用户

Polygon.io的WebSocket数据流与我们的REST端点从相同的强大数据源获取数据。我们将与所有主要美国股票交易所的直接连接与SIP整合的数据流相结合，确保您接收到最准确、及时和全面的市场数据。

一旦交易、报价或其他市场事件由交易所发布并由SIP整合，它们就会通过我们的基础设施传递，并通过WebSocket通道推送给您订阅的客户端。这种近乎即时的传递支持实时决策和交易或分析系统的动态更新。

## WebSocket数据流导航

Polygon.io的WebSocket接口为股票数据提供了以下主要数据流类别，这些类别在官方文档导航中如下组织：

```
股票 (Stocks)
  |
  ├── 概述 (Overview)
  |
  ├── 聚合数据（每分钟）(Aggregates (Per Minute))
  |
  ├── 聚合数据（每秒）(Aggregates (Per Second))
  |
  ├── 交易 (Trades)
  |
  ├── 报价 (Quotes)
  |
  ├── 涨跌停限制 (Limit-Up Limit-Down (LULD))
  |
  └── 公平市场价值 (Fair Market Value)
```

每个数据流都有特定的订阅格式和数据结构，可以单独订阅或组合使用。以下部分将详细介绍每个数据流的特点和用途。

## 可用的WebSocket数据流

我们的WebSocket通道提供广泛的流式数据，涵盖市场活动的所有关键方面：

### 聚合数据（每分钟）

**导航路径**: `Docs / WebSocket / Stocks / Aggregates (Per Minute)`

**WebSocket端点**: 
- 实时数据: `wss://socket.polygon.io/stocks`
- 延迟数据: `wss://delayed.polygon.io/stocks`

> ℹ️ **注意**: 延迟数据比实时数据滞后15分钟。升级您的计划以启用实时数据。

通过WebSocket流式传输指定股票的分钟级聚合OHLC（开盘、最高、最低、收盘）和成交量数据。这些聚合数据在美国东部时间(ET)持续更新，涵盖盘前、常规和盘后交易时段。每个K线仅由符合特定条件的合格交易构建；如果在给定分钟内没有发生符合条件的交易，则不会生成K线。通过提供稳定的聚合K线流，该端点使用户能够跟踪日内价格走势，完善交易策略，并为实时数据可视化提供支持。

**用途**：实时监控、动态图表、日内策略开发、自动化交易。

**参数**：
- **ticker** (字符串，必需)：指定股票代码或使用`*`订阅所有股票。您也可以使用逗号分隔的列表订阅多个股票代码。您可以从我们的[股票代码API](https://polygon.io/docs/stocks/get_v3_reference_tickers)获取可用的股票代码。

**订阅格式**：`A.{TICKER}`

**代码示例**:

<选项卡：Shell>
```bash
wscat -c wss://delayed.polygon.io/stocks

# 连接成功后，进行认证
{"action":"auth","params":"YOUR_API_KEY"}

# 认证成功后，订阅数据
{"action":"subscribe","params":"AM.AAPL"}
```

<选项卡：Python>
```python
package main

import (
    "log"
    "os"
    "os/signal"
    
    polygonws "github.com/polygon-io/client-go/websocket"
    "github.com/polygon-io/client-go/websocket/models"
)

func main() {
    // 创建新的WebSocket客户端实例
    c, err := polygonws.New(polygonws.Config{
        ApiKey: "YOUR_API_KEY",
        Feed:   polygonws.Delayed,
        Market: polygonws.Stocks,
    })
    
    // ... 错误处理等代码
    
    // 订阅AAPL的分钟级聚合数据
    if err := c.Subscribe(models.MinuteAggs, "AAPL"); err != nil {
        log.Fatal(err)
    }
    
    // ... 接收和处理数据的代码
}
```

**响应属性**：
- **ev** (枚举值 "AM")：事件类型
- **sym** (字符串)：给定股票的代码
- **v** (整数)：此时段成交量
- **av** (整数)：当天累计成交量
- **op** (数字)：当天官方开盘价
- **vw** (数字)：此时段的成交量加权平均价格
- **o** (数字)：此聚合窗口的开盘价
- **c** (数字)：此聚合窗口的收盘价
- **h** (数字)：此聚合窗口的最高价
- **l** (数字)：此聚合窗口的最低价
- **a** (数字)：当天的成交量加权平均价格
- **z** (整数)：此聚合窗口的平均交易规模
- **s** (整数)：此聚合窗口的开始时间戳（Unix毫秒）
- **e** (整数)：此聚合窗口的结束时间戳（Unix毫秒）
- **otc** (布尔值)：此聚合是否为场外交易股票。如果为false，此字段将被省略。

**示例响应**：
```json
{
  "ev": "AM",
  "sym": "AAPL",
  "v": 12345,
  "av": 500000,
  "op": 156.82,
  "vw": 157.32,
  "o": 156.82,
  "c": 157.65,
  "h": 157.89,
  "l": 156.72,
  "a": 157.45,
  "s": 1617302340000,
  "e": 1617302400000
}
```

**参考链接**：[Polygon.io 每分钟聚合数据](https://polygon.io/docs/websocket/stocks/aggregates-per-minute)

### 聚合数据（每秒）
通过WebSocket流式传输指定股票的秒级聚合OHLC（开盘、最高、最低、收盘）和成交量数据。这些聚合数据在美国东部时间(ET)持续更新，涵盖盘前、常规和盘后交易时段。每个K线仅由符合特定条件的合格交易构建；如果在给定秒内没有发生符合条件的交易，则不会生成K线。通过提供精细的聚合K线流，该端点特别适用于高频交易策略、量化分析和需要极高精度的市场监控。

**用途**：实时监控、动态图表、日内策略开发、自动化交易。

**参数**：
- **ticker** (字符串，必需)：指定股票代码或使用*订阅所有股票。您也可以使用逗号分隔的列表订阅多个股票代码。您可以从股票代码API获取可用的股票代码。

**订阅格式**：`AS.{TICKER}`

**响应属性**：
- **ev** (枚举值 "A")：事件类型
- **sym** (字符串)：给定股票的代码
- **v** (整数)：此时段成交量
- **av** (整数)：当天累计成交量
- **op** (数字)：当天官方开盘价
- **vw** (数字)：此时段的成交量加权平均价格
- **o** (数字)：此聚合窗口的开盘价
- **c** (数字)：此聚合窗口的收盘价
- **h** (数字)：此聚合窗口的最高价
- **l** (数字)：此聚合窗口的最低价
- **a** (数字)：当天的成交量加权平均价格
- **z** (整数)：此聚合窗口的平均交易规模
- **s** (整数)：此聚合窗口的开始时间戳（Unix毫秒）
- **e** (整数)：此聚合窗口的结束时间戳（Unix毫秒）
- **otc** (布尔值)：此聚合是否为场外交易股票。如果为false，此字段将被省略。

**示例响应**：
```json
{
  "ev": "AS",
  "sym": "AAPL",
  "v": 562,
  "av": 120345,
  "op": 156.82,
  "vw": 156.83,
  "o": 156.82,
  "c": 156.83,
  "h": 156.84,
  "l": 156.81,
  "a": 156.83,
  "s": 1617302399000,
  "e": 1617302400000
}
```

**参考链接**：[Polygon.io 每秒聚合数据](https://polygon.io/docs/websocket/stocks/aggregates-per-second)

### 交易数据
实时流式传输每笔执行的交易，包括价格、规模、交易所和条件。非常适合逐笔分析、订单流研究和高响应性交易算法。

**订阅格式**：`T.{TICKER}`

**示例响应**：
```json
{
  "ev": "T",
  "sym": "AAPL",
  "i": 96921,
  "x": 4,
  "p": 157.65,
  "s": 100,
  "c": [37],
  "t": 1617302400512,
  "q": 7897987,
  "z": 3
}
```

### 报价数据

**导航路径**: `Docs / WebSocket / Stocks / Quotes`

**WebSocket端点**: 
- 实时数据: `wss://socket.polygon.io/stocks`
- 延迟数据: `wss://delayed.polygon.io/stocks`

通过WebSocket流式传输股票代码的NBBO（全国最佳买卖报价）数据。每条消息提供当前最佳买入/卖出价格、规模和相关元数据，随着它们的更新而传递，使用户能够监控不断变化的市场状况，为交易决策提供信息，并维护响应迅速的、数据驱动的应用程序。

**用途**：实时监控、市场分析、交易决策支持、动态界面更新。

**参数**：
- **ticker** (字符串，必需)：指定股票代码或使用`*`订阅所有股票。您也可以使用逗号分隔的列表订阅多个股票代码。您可以从我们的[股票代码API](https://polygon.io/docs/stocks/get_v3_reference_tickers)获取可用的股票代码。

**订阅格式**：`Q.{TICKER}`

**响应属性**：
- **ev** (枚举值 "Q")：事件类型
- **sym** (字符串)：给定股票的代码
- **bx** (整数)：买方交易所ID
- **bp** (数字)：买方价格
- **bs** (整数)：买方规模。这表示在给定买入价格下的整手订单数量。正常整手规模为100股。买入规模为2表示在给定买入价格下有200股可供购买。
- **ax** (整数)：卖方交易所ID
- **ap** (数字)：卖方价格
- **as** (整数)：卖方规模。这表示在给定卖出价格下的整手订单数量。正常整手规模为100股。卖出规模为2表示在给定卖出价格下有200股可供购买。
- **c** (整数)：条件
- **i** (整数数组)：指标。有关更多信息，请参阅我们的[条件和指标词汇表](https://polygon.io/glossary)。
- **t** (整数)：SIP时间戳，Unix毫秒格式
- **q** (整数)：序列号表示报价事件发生的顺序。这些值对每个股票代码是递增且唯一的，但不一定是连续的（例如1, 2, 6, 9, 10, 11）。值在每个交易会话/日后重置。
- **z** (整数)：交易所代码。(1 = NYSE, 2 = AMEX, 3 = Nasdaq)

**示例响应**：
```json
{
  "ev": "Q",
  "sym": "AAPL",
  "bx": 12,
  "bp": 157.62,
  "bs": 500,
  "ax": 15,
  "ap": 157.65,
  "as": 300,
  "c": [0],
  "t": 1617302400435,
  "q": 7897986,
  "z": 3
}
```

**参考链接**：[Polygon.io 报价数据](https://polygon.io/docs/websocket/stocks/quotes)

### 涨跌停限制 (LULD)

**导航路径**: `Docs / WebSocket / Stocks / Limit-Up Limit-Down (LULD)`

**WebSocket端点**: 
- 实时数据: `wss://socket.polygon.io/stocks`
- 延迟数据: `wss://delayed.polygon.io/stocks`

通过WebSocket流式传输指定股票代码的实时涨跌停限制(LULD)事件。每个事件表示由监管机制触发的价格波动保障，如价格区间或交易暂停，帮助用户识别证券何时进入或退出限制状态、暂停或在允许的价格范围内恢复交易。这种连续的数据流使交易员、分析师和开发人员能够更有效地应对突然的市场走势，并相应地调整其策略。

**用途**：波动性监控、风险管理、合规跟踪、交易策略调整。

**参数**：
- **ticker** (字符串，必需)：指定股票代码或使用`*`订阅所有股票。您也可以使用逗号分隔的列表订阅多个股票代码。您可以从我们的[股票代码API](https://polygon.io/docs/stocks/get_v3_reference_tickers)获取可用的股票代码。

**订阅格式**：`LULD.{TICKER}`

**响应属性**：
- **ev** (枚举值 "LULD")：事件类型
- **T** (字符串)：给定股票的代码
- **h** (数字)：最高价
- **l** (数字)：最低价
- **i** (整数数组)：指标
- **z** (整数)：交易所代码。(1 = NYSE, 2 = AMEX, 3 = Nasdaq)
- **t** (整数)：时间戳，Unix毫秒格式
- **q** (整数)：序列号表示消息事件发生的顺序。这些值对每个股票代码是递增且唯一的，但不一定是连续的（例如1, 2, 6, 9, 10, 11）。

**示例响应**：
```json
{
  "ev": "LULD",
  "T": "AAPL",
  "h": 172.76,
  "l": 145.35,
  "i": [1, 2],
  "z": 3,
  "t": 1617302400435,
  "q": 12345
}
```

**参考链接**：[Polygon.io 涨跌停限制](https://polygon.io/docs/websocket/stocks/luld)

### 公平市场价值 (FMV)

**导航路径**: `Docs / WebSocket / Stocks / Fair Market Value`

**WebSocket端点**: 
- 实时数据: `wss://socket.polygon.io/stocks`
- 延迟数据: `wss://delayed.polygon.io/stocks`

通过WebSocket流式传输指定股票代码的实时公平市场价值(FMV)数据。这种专有指标，仅适用于商业计划用户，提供了一个算法派生的、实时的证券公平市场价格估计。通过提供准确、连续的估值数据，该数据流支持明智的交易决策、增强分析和更有效的风险管理。

**用途**：定价策略、算法建模、风险评估、投资者决策制定。

**参数**：
- **ticker** (字符串，必需)：指定股票代码或使用`*`订阅所有股票。您也可以使用逗号分隔的列表订阅多个股票代码。您可以从我们的[股票代码API](https://polygon.io/docs/stocks/get_v3_reference_tickers)获取可用的股票代码。

**订阅格式**：`FMV.{TICKER}`

**响应属性**：
- **ev** (枚举值 "FMV")：事件类型
- **fmv** (未知类型)：公平市场价值仅适用于商业计划。这是我们的专有算法，用于生成可交易证券的实时、准确的公平市场价值。更多信息，请[联系我们](https://polygon.io/contact-sales)。
- **sym** (未知类型)：给定证券的代码
- **t** (未知类型)：纳秒级时间戳

**示例响应**：
```json
{
  "ev": "FMV",
  "sym": "AAPL",
  "fmv": 157.63,
  "t": 1617302400435
}
```

**参考链接**：[Polygon.io 公平市场价值](https://polygon.io/docs/websocket/stocks/fair-market-value)

## 连接和认证

要连接到Polygon.io的WebSocket服务：

```
wss://socket.polygon.io/stocks
```

连接后，您需要进行认证：

```json
{
  "action": "auth",
  "params": "YOUR_API_KEY"
}
```

成功认证的响应：

```json
{
  "ev": "status",
  "status": "auth_success",
  "message": "authenticated"
}
```

## 订阅格式

订阅特定数据流的基本格式：

```json
{
  "action": "subscribe",
  "params": "STREAM_NAME.SYMBOL"
}
```

例如，订阅AAPL的交易数据：

```json
{
  "action": "subscribe",
  "params": "T.AAPL"
}
```

可用的流名称前缀：
- `A` - 每分钟聚合数据
- `AM` - 每分钟聚合数据（历史兼容性）
- `AS` - 每秒聚合数据
- `T` - 交易
- `Q` - 报价
- `LULD` - 涨跌停限制
- `FMV` - 公平市场价值（仅商业计划）

您可以一次订阅多个数据流：

```json
{
  "action": "subscribe",
  "params": ["T.AAPL", "Q.AAPL", "A.AAPL"]
}
```

订阅成功的响应：

```json
{
  "ev": "status",
  "status": "success",
  "message": "subscribed to: T.AAPL, Q.AAPL, A.AAPL"
}
```

取消订阅：

```json
{
  "action": "unsubscribe",
  "params": "T.AAPL"
}
```

## 错误处理

WebSocket连接可能会因网络问题或其他原因而断开。实现自动重连逻辑是一种最佳做法。断开连接后，您需要重新认证并重新订阅所有需要的数据流。

监听错误消息：

```json
{
  "ev": "status",
  "status": "error",
  "message": "Error description"
}
```

常见错误包括：
- 认证失败
- 无效的订阅参数
- 超出订阅限制
- 服务器维护或临时中断

## 最佳实践

1. **保持活动连接** - 实现心跳机制或定期发送无害消息以保持连接活跃。
2. **批量订阅** - 尽可能将多个订阅合并为一个请求，而不是发送多个单独的订阅消息。
3. **错误处理** - 实现强健的错误处理和重连逻辑。
4. **资源管理** - 监控内存和处理开销，特别是当订阅大量股票时。
5. **时间同步** - 确保您的系统时钟准确，以便正确解释时间戳。
6. **优雅降级** - 在数据中断期间实现后备逻辑。
7. **数据验证** - 验证接收到的数据以确保完整性和一致性。

通过利用Polygon.io的股票WebSocket数据流，您可以将应用程序定位在实时市场情报的前沿，支持快速、数据驱动的决策和美国股票市场的创新。

参考链接：[Polygon.io WebSocket Overview](https://polygon.io/docs/websocket/stocks/overview)
